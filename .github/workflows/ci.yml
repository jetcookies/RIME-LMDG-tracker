name: Track LTS

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Get remote digest
        id: remote
        run: |
          DIGEST=$(gh api repos/amzxyz/RIME-LMDG/releases/tags/LTS --jq '.assets[] | select(.name=="wanxiang-lts-zh-hans.gram").digest')
          DATE=$(date +%Y-%m-%d -d $(gh api repos/amzxyz/RIME-LMDG/releases/tags/LTS --jq '.assets[] | select(.name=="wanxiang-lts-zh-hans.gram").updated_at'))
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compare with last known
        id: cmp
        run: |
          OLD=$(cat .lts-digest)
          NEW="${{ steps.remote.outputs.digest }}"
          if [[ "$OLD" != "$NEW" ]]; then
            echo "changed=true"  >> $GITHUB_OUTPUT
            echo "new_digest=$NEW" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Download new file
        if: steps.cmp.outputs.changed == 'true'
        run: |
          curl -LO https://github.com/amzxyz/RIME-LMDG/releases/download/LTS/wanxiang-lts-zh-hans.gram

      - name: Persist new digest
        if: steps.cmp.outputs.changed == 'true'
        run: |
          echo "${{ steps.cmp.outputs.new_digest }}" > .lts-digest
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .lts-digest
          git commit -m "chore: update digest ${{ steps.cmp.outputs.new_digest }}"
          git push

      - name: Create release tag
        if: steps.cmp.outputs.changed == 'true'
        id: tag
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          DATE="${{ steps.remote.outputs.date }}"
          DIGEST_SHORT=$(echo "${{ steps.remote.outputs.digest }}" | cut -c 8-14)
          TAG="0-unstable-${DATE}"
          git tag "${TAG}"
          git push origin "${TAG}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
        env:
          NEW_DIGEST: ${{ steps.cmp.outputs.new_digest }}

      - name: Create GitHub release
        if: steps.cmp.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "${{ steps.tag.outputs.tag }}"
          files: wanxiang-lts-zh-hans.gram