name: Track LTS

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Get remote metadata
        id: remote
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取 digest 和 updated_at
          METADATA=$(gh api repos/amzxyz/RIME-LMDG/releases/tags/LTS --jq '.assets[] | select(.name=="wanxiang-lts-zh-hans.gram") | "\(.digest) \(.updated_at)"')
          
          DIGEST=$(echo $METADATA | cut -d' ' -f1)
          RAW_DATE=$(echo $METADATA | cut -d' ' -f2)
          FORMATTED_DATE=$(date +%Y-%m-%d -d "$RAW_DATE")
          
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "date=$FORMATTED_DATE" >> $GITHUB_OUTPUT

      - name: Compare and Process
        id: cmp
        run: |
          NEW_DIGEST="${{ steps.remote.outputs.digest }}"
          # 如果文件不存在，则 OLD_DIGEST 为空
          OLD_DIGEST=$(cat .lts-digest 2>/dev/null || echo "")

          if [[ "$OLD_DIGEST" != "$NEW_DIGEST" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "$NEW_DIGEST" > .lts-digest
          fi

      - name: Update and Tag
        if: steps.cmp.outputs.changed == 'true'
        id: tag
        run: |
          # 全局配置 Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 1. 下载文件
          curl -LO https://github.com/amzxyz/RIME-LMDG/releases/download/LTS/wanxiang-lts-zh-hans.gram
          
          # 2. 持久化并推送 digest
          git add .lts-digest
          git commit -m "chore: update digest ${{ steps.remote.outputs.digest }}"
          git push
          
          # 3. 创建并推送 Tag
          TAG="0-unstable-${{ steps.remote.outputs.date }}"
          git tag "$TAG"
          git push origin "$TAG"
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub release
        if: steps.cmp.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          files: wanxiang-lts-zh-hans.gram